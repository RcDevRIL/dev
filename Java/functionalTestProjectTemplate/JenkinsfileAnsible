pipeline{
	agent any
	tools {
		maven 'Maven'
	}
	stages{
		stage("Prepare"){
			steps{
				echo "prepare"
				checkout scm
			}
		}
		stage("Build") {
			steps{ // ensure interface is running
				script {
					// deploy configuration for testing
					build job: 'Functional test/DEPLOY_CONFIG_DEV', propagate: true, wait: true,
					parameters: [
						string(name: 'contextinterface', value: "interfaceContextName"),
						string(name: 'source', value: "source_username"),
						string(name: 'target', value: "target_username"),
						string(name: 'configurationfile', value: "interfaceName.properties"),
						string(name: 'templatefile', value: "interfaceNameTest.properties.j2")
					]
					try {
						sh 'mvn clean test'
					}
					finally { // restore configuration for interface
						// deploy configuration for interface
						build job: 'Functional test/DEPLOY_CONFIG_DEV', propagate: true, wait: true,
						parameters: [
							string(name: 'contextinterface', value: "interfaceContextName"),
							string(name: 'source', value: "source_username"),
							string(name: 'target', value: "target_username"),
							string(name: 'configurationfile', value: "interfaceName.properties"),
							string(name: 'templatefile', value: "interfaceName.properties.j2")
						]
					}
				}
			}
		}
	}
	post{
		always {
			cucumber buildStatus: 'UNSTABLE',
			failedFeaturesNumber: -1,
			failedScenariosNumber: -1,
			skippedStepsNumber: -1,
			failedStepsNumber: -1,
			pendingStepsNumber: -1,
			undefinedStepsNumber: -1,
			fileIncludePattern: '**/interfaceName-*-report.json',
			sortingMethod: 'ALPHABETICAL',
			trendsLimit: 100
		}
	}
}

